name: bluebuild
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  bluebuild:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    strategy:
      matrix:
        recipe:
          - recipe.yml
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Recreate cosign public key from secret at runtime
      - name: Provide cosign public key (from secret)
        env:
          COSIGN_PUB: ${{ secrets.COSIGN_PUB }}
        run: |
          if [ -n "$COSIGN_PUB" ]; then
            printf '%s\n' "$COSIGN_PUB" > cosign.pub
            chmod 644 cosign.pub
          else
            echo "COSIGN_PUB not set; skipping cosign.pub creation"
          fi

      # Recreate cosign private key from secret at runtime
      - name: Provide cosign private key (from secret)
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
        run: |
          if [ -n "$COSIGN_PRIVATE_KEY" ]; then
            printf '%s\n' "$COSIGN_PRIVATE_KEY" > cosign.key
            chmod 600 cosign.key
          else
            echo "COSIGN_PRIVATE_KEY not set; skipping cosign.key creation"
          fi

      - name: Build Custom Image (blue-build)
        uses: blue-build/github-action@v1.10
        with:
          recipe: ${{ matrix.recipe }}
          registry_token: ${{ github.token }}
          pr_event_number: ${{ github.event.number }}
          use_unstable_cli: true
          maximize_build_space: true
          # No cosign_private_key input: bluebuild will use cosign.key / cosign.pub in the repo root
