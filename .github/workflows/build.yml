name: bluebuild
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  bluebuild:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    strategy:
      matrix:
        recipe:
          - recipe.yml
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Optionally inject public key from secret if you don't commit cosign.pub
      - name: Provide cosign public key (from secret)
        if: ${{ secrets.COSIGN_PUB != '' }}
        run: |
          printf '%s\n' "${{ secrets.COSIGN_PUB }}" > cosign.pub
          chmod 644 cosign.pub

      # Provide private key file for actions/tools that expect a file (kept only in runner)
      - name: Provide cosign private key (from secret)
        if: ${{ secrets.COSIGN_PRIVATE_KEY != '' }}
        run: |
          printf '%s\n' "${{ secrets.COSIGN_PRIVATE_KEY }}" > cosign.key
          chmod 600 cosign.key

      - name: Build Custom Image (blue-build)
        uses: blue-build/github-action@v1.10
        with:
          recipe: ${{ matrix.recipe }}
          registry_token: ${{ github.token }}
          pr_event_number: ${{ github.event.number }}
          use_unstable_cli: true
          maximize_build_space: true
          # cosign_private_key removed; the action should read from cosign.key if needed
